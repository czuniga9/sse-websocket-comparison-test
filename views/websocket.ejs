<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>WebSocket Sample</title>
  <script src="https://cdn.socket.io/4.8.0/socket.io.min.js"></script>
  <style>
    * { box-sizing: border-box; }
    body { font-family: system-ui, sans-serif; max-width: 640px; margin: 2rem auto; padding: 0 1rem; }
    h1 { font-size: 1.25rem; }
    .status { padding: 0.5rem; border-radius: 6px; margin-bottom: 1rem; }
    .status.connected { background: #d4edda; color: #155724; }
    .status.disconnected { background: #f8d7da; color: #721c24; }
    section { margin-bottom: 1.5rem; }
    h2 { display: block; margin-bottom: 0.25rem; font-weight: 500; }
    input, button { padding: 0.5rem 0.75rem; margin-right: 0.5rem; margin-bottom: 0.5rem; }
    button { cursor: pointer; background: #0d6efd; color: #fff; border: none; border-radius: 6px; }
    button:hover { background: #0b5ed7; }
    #log { background: #f5f5f5; padding: 0.75rem; border-radius: 6px; font-family: monospace; font-size: 0.875rem; overflow-y: auto; }
    #log p { margin: 0.25rem 0; }
  </style>
</head>
<body>
  <h1>WebSocket Sample</h1>
  <div id="status" class="status disconnected">Disconnected</div>

  <section>
    <h2>Quotes (streamed, then connection closes)</h2>
    <div id="log"></div>
  </section>

  <script>
    const statusEl = document.getElementById('status');
    const logEl = document.getElementById('log');

    function log(msg, type) {
      const p = document.createElement('p');
      p.textContent = (type ? '[' + type + '] ' : '') + msg;
      logEl.appendChild(p);
      logEl.scrollTop = logEl.scrollHeight;
    }

    let socket = null;

    function connectAndStartQuotes() {
      if (socket && socket.connected) {
        emitPayload();
        return;
      }
      log('Connectingâ€¦');
      socket = io(window.location.origin);

      socket.on('connect', function () {
        statusEl.textContent = 'Connected';
        statusEl.className = 'status connected';
        log('Connected');
        emitPayload();
      });

      socket.on('disconnect', function (reason) {
        statusEl.textContent = 'Disconnected';
        statusEl.className = 'status disconnected';
        log('Disconnected. ' + (reason === 'io server disconnect' ? 'All quotes sent, connection closed.' : reason));
      });

      socket.on('connect_error', function (err) {
        log('Connection error: ' + err.message, 'error');
      });

      socket.on('data', function (data) {
        log('Initial data: ' + (typeof data === 'object' ? JSON.stringify(data) : data));
      });

      socket.on('quote', function (data) {
        log('Quote: ' + (typeof data === 'string' ? data : JSON.stringify(data)));
      });
    }

    function emitPayload() {
      const raw = 'no data';
      let payload = {};
      if (raw) {
        try {
          payload = raw.startsWith('{') ? JSON.parse(raw) : { value: raw };
        } catch (_) {
          payload = { value: raw };
        }
      }
      socket.emit('pollQuotes', payload);
      log('Sent pollQuotes with payload');
    }

    window.addEventListener('DOMContentLoaded', function () {
      connectAndStartQuotes();
    });
  </script>
</body>
</html>